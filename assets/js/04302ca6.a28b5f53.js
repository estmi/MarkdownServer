"use strict";(self.webpackChunkmarkdown_website=self.webpackChunkmarkdown_website||[]).push([[30],{6907:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>c,contentTitle:()=>s,default:()=>m,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"Gisce/migrations/migration","title":"Com fer una migracio","description":"Estructura base","source":"@site/docs/Gisce/migrations/migration.md","sourceDirName":"Gisce/migrations","slug":"/Gisce/migrations/migration","permalink":"/MarkdownServer/docs/Gisce/migrations/migration","draft":false,"unlisted":false,"editUrl":"https://github.com/estmi/MarkdownServer/tree/master/docs/Gisce/migrations/migration.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Language Migration","permalink":"/MarkdownServer/docs/Gisce/migrations/language_migration"},"next":{"title":"Utilitzacio basica de ORM","permalink":"/MarkdownServer/docs/Gisce/orm/"}}');var t=n(4848),o=n(8453);const i={},s="Com fer una migracio",c={},l=[{value:"Estructura base",id:"estructura-base",level:2},{value:"load_data_records",id:"load_data_records",level:2},{value:"Utilitzar si la migracio es podria ometre en cas de update all",id:"utilitzar-si-la-migracio-es-podria-ometre-en-cas-de-update-all",level:2},{value:"Actualitzar ondelete de un one2many",id:"actualitzar-ondelete-de-un-one2many",level:2}];function d(e){const a={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.header,{children:(0,t.jsx)(a.h1,{id:"com-fer-una-migracio",children:"Com fer una migracio"})}),"\n",(0,t.jsx)(a.h2,{id:"estructura-base",children:"Estructura base"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-python",children:"# -*- coding: utf-8 -*-\nimport logging\n\ndef up(cursor, installed_version):\n    if not installed_version:\n        return\n\n    logger = logging.getLogger('openerp.migration')\n\n\ndef down(cursor, installed_version):\n    pass\n\n\nmigrate = up\n\n"})}),"\n",(0,t.jsx)(a.h2,{id:"load_data_records",children:"load_data_records"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-python",children:"#Importar a dalt de tot\nfrom oopgrade.oopgrade import load_data_records\n\n# Informar modul de treball, arxiu on esta l'id existent i quins ids volem importar\nmigration_filename = #Arxiu migracio\nmodule_name = # nom modul actual\nfilename = # xml a actualitzar\nrecords_ids = # [] # ids a actualitzar\n\nlogger.info('START:[{}]load_data_records'.format(migration_filename))\nload_data_records(cursor, module_name, filename, records_ids, mode='update')\nlogger.info('END:[{}]load_data_records'.format(migration_filename))\n"})}),"\n",(0,t.jsx)(a.h2,{id:"utilitzar-si-la-migracio-es-podria-ometre-en-cas-de-update-all",children:"Utilitzar si la migracio es podria ometre en cas de update all"}),"\n",(0,t.jsx)(a.p,{children:"En un update all hi ha molts processos que passen, entre ells, sincronitzacio python BD, aka. _auto_init i tambe es carreguen els xmls, aka load_data."}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-python",children:"from tools import config\nif config.updating_all:\n    return\n"})}),"\n",(0,t.jsx)(a.h2,{id:"actualitzar-ondelete-de-un-one2many",children:"Actualitzar ondelete de un one2many"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-python",children:"        def update_contraint(cursor, constraint_name, ondelete):\n            sql = \"\"\"SELECT confdeltype, conname, cl1.relname as _table, att1.attname as k, cl2.relname as ref, att2.attname as id FROM pg_constraint as con, pg_class as cl1, pg_class as cl2,\n    pg_attribute as att1, pg_attribute as att2\n    WHERE con.conrelid = cl1.oid\n    AND con.confrelid = cl2.oid\n    AND array_lower(con.conkey, 1) = 1\n    AND con.conkey[1] = att1.attnum\n    AND att1.attrelid = cl1.oid\n    AND array_lower(con.confkey, 1) = 1\n    AND con.confkey[1] = att2.attnum\n    AND att2.attrelid = cl2.oid\n    AND con.contype = 'f' and conname = '{}'\"\"\".format(constraint_name)\n            cursor.execute(sql)\n            res = cursor.dictfetchall()[0]\n\n            cursor.execute('ALTER TABLE \"' + res['_table'] + '\" DROP CONSTRAINT \"' + res['conname'] + '\"')\n            cursor.execute('ALTER TABLE \"' + res['_table'] + '\" ADD FOREIGN KEY (\"' + res['k'] + '\") REFERENCES \"' + res['ref'] + '\" ON DELETE ' + ondelete)\n"})})]})}function m(e={}){const{wrapper:a}={...(0,o.R)(),...e.components};return a?(0,t.jsx)(a,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,a,n)=>{n.d(a,{R:()=>i,x:()=>s});var r=n(6540);const t={},o=r.createContext(t);function i(e){const a=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function s(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(o.Provider,{value:a},e.children)}}}]);